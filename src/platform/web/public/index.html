<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GuildSpace</title>
  <style>
    :root {
      --bg: #0a0a12;
      --surface: #12121f;
      --surface2: #1a1a2e;
      --border: #2a2a4a;
      --text: #e0e0f0;
      --text-dim: #8888aa;
      --accent: #6c5ce7;
      --accent-dim: #4a3cb0;
      --green: #00b894;
      --red: #e17055;
      --yellow: #fdcb6e;
      --blue: #74b9ff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Courier New', monospace;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 16px; color: var(--accent); }
    header .user-info { color: var(--text-dim); font-size: 13px; }

    /* â”€â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 16px;
    }
    #login-screen h2 { color: var(--accent); margin-bottom: 8px; }
    #login-screen button {
      background: #5865F2;
      color: white;
      border: none;
      padding: 12px 32px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    #login-screen button:hover { background: #4752C4; }

    #setup-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 16px;
    }
    #setup-screen h2 { color: var(--accent); margin-bottom: 8px; }

    /* â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    #app.active { display: flex; }

    /* â”€â”€â”€ Messages Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 700px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; } }

    .message.command {
      color: var(--text-dim);
      font-size: 13px;
    }
    .message.command::before {
      content: '> ';
      color: var(--accent);
    }

    .message.error { color: var(--red); }
    .message.system { color: var(--text-dim); font-style: italic; font-size: 13px; }
    .message.chat { font-style: normal; }
    .chat-time { color: var(--text-dim); font-size: 12px; }
    .chat-name { color: var(--accent); font-weight: bold; }
    .chat-name.chat-me { color: #8bc34a; }
    .chat-text { color: var(--text); }
    .message.text-reply { white-space: pre-wrap; }

    /* â”€â”€â”€ Embeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .embed {
      border-left: 3px solid var(--green);
      background: var(--surface);
      padding: 12px 16px;
      border-radius: 0 4px 4px 0;
      margin: 4px 0;
    }
    .embed.color-Red { border-left-color: var(--red); }
    .embed.color-Blue { border-left-color: var(--blue); }
    .embed.color-Yellow { border-left-color: var(--yellow); }
    .embed.color-Green { border-left-color: var(--green); }

    .embed-title { font-weight: bold; margin-bottom: 6px; font-size: 15px; }
    .embed-description { color: var(--text-dim); margin-bottom: 10px; font-size: 13px; white-space: pre-wrap; }

    .embed-fields { display: flex; flex-wrap: wrap; gap: 4px 20px; }
    .embed-field { min-width: 120px; margin-bottom: 8px; }
    .embed-field.full-width { width: 100%; }
    .embed-field-name { font-weight: bold; font-size: 12px; color: var(--text-dim); margin-bottom: 2px; }
    .embed-field-value { font-size: 13px; white-space: pre-wrap; }

    /* â”€â”€â”€ Components (Buttons, Selects) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .components { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }

    .comp-button {
      padding: 6px 16px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      border-radius: 3px;
    }
    .comp-button:hover { background: var(--border); }
    .comp-button.style-Success { border-color: var(--green); color: var(--green); }
    .comp-button.style-Danger { border-color: var(--red); color: var(--red); }
    .comp-button.style-Primary { border-color: var(--accent); color: var(--accent); }

    .comp-select {
      padding: 6px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      min-width: 200px;
      border-radius: 3px;
    }

    /* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    #modal-overlay.active { display: flex; }

    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: 6px;
      min-width: 400px;
      max-width: 600px;
    }
    .modal-box h3 { margin-bottom: 16px; color: var(--accent); }
    .modal-box textarea, .modal-box input[type="text"] {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 3px;
    }
    .modal-box textarea { min-height: 150px; resize: vertical; }
    .modal-box label { display: block; margin-bottom: 4px; color: var(--text-dim); font-size: 12px; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }

    /* â”€â”€â”€ Command Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-area {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      gap: 8px;
      position: relative;
    }
    #command-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      padding: 10px 14px;
      border-radius: 4px;
    }
    #command-input:focus { outline: none; border-color: var(--accent); }
    #command-input::placeholder { color: var(--text-dim); }

    #send-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }

    /* â”€â”€â”€ Autocomplete Dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #autocomplete {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 20px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px 4px 0 0;
      max-height: 300px;
      overflow-y: auto;
    }
    #autocomplete.active { display: block; }

    .ac-item {
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }
    .ac-item:hover, .ac-item.selected { background: var(--surface2); }
    .ac-item .ac-name { color: var(--text); }
    .ac-item .ac-desc { color: var(--text-dim); font-size: 12px; margin-left: 8px; }

    /* â”€â”€â”€ Command Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .command-help {
      position: absolute;
      bottom: 100%;
      left: 20px;
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--text-dim);
      display: none;
    }
    .command-help.active { display: block; }
    .command-help .opt { color: var(--accent); }
    .command-help .opt.required { color: var(--yellow); }

    /* â”€â”€â”€ Deferred (loading) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading::after {
      content: ' â³';
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
  <h2>ğŸ° GuildSpace</h2>
  <p style="color: var(--text-dim); margin-bottom: 16px;">Guild Platform</p>
  <button onclick="window.location.href='/api/auth/discord'" style="display:flex; align-items:center; justify-content:center; gap:8px;">
    <svg width="20" height="15" viewBox="0 0 71 55" fill="none"><path d="M60.1 4.9A58.5 58.5 0 0045.4.2a.2.2 0 00-.2.1 40.8 40.8 0 00-1.8 3.7 54 54 0 00-16.2 0A37.4 37.4 0 0025.4.3a.2.2 0 00-.2-.1A58.4 58.4 0 0010.5 4.9a.2.2 0 00-.1.1C1.5 18.7-.9 32.2.3 45.5v.1a58.8 58.8 0 0017.7 9a.2.2 0 00.3-.1 42 42 0 003.6-5.9.2.2 0 00-.1-.3 38.8 38.8 0 01-5.5-2.6.2.2 0 01 0-.4l1.1-.9a.2.2 0 01.2 0 42 42 0 0035.6 0 .2.2 0 01.2 0l1.1.9a.2.2 0 010 .4 36.4 36.4 0 01-5.5 2.6.2.2 0 00-.1.3 47.2 47.2 0 003.6 5.9.2.2 0 00.3.1 58.6 58.6 0 0017.7-9v-.1c1.4-15-2.3-28.4-9.8-40.1a.2.2 0 00-.1-.1zM23.7 37.3c-3.5 0-6.3-3.2-6.3-7s2.8-7 6.3-7 6.4 3.2 6.3 7-2.8 7-6.3 7zm23.2 0c-3.5 0-6.3-3.2-6.3-7s2.8-7 6.3-7 6.4 3.2 6.3 7-2.8 7-6.3 7z" fill="white"/></svg>
    Log in with Discord
  </button>
</div>

<!-- Name Setup Screen -->
<div id="setup-screen" style="display:none;">
  <h2>ğŸ° Welcome to GuildSpace</h2>
  <p style="color: var(--text-dim); margin-bottom: 16px;">Choose your name</p>
  <input type="text" id="setup-name" placeholder="Your GuildSpace name" maxlength="32" style="background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 10px 16px; font-family: inherit; font-size: 14px; width: 280px; border-radius: 4px;">
  <p id="setup-error" style="color: #e74c3c; font-size: 13px; display: none;"></p>
  <button id="setup-btn" onclick="submitName()" style="background: var(--accent); color: white; border: none; padding: 10px 32px; font-family: inherit; font-size: 14px; cursor: pointer; border-radius: 4px;">Let's go</button>
</div>

<!-- Main App -->
<div id="app">
  <header>
    <h1>ğŸ° GuildSpace â€” Command Terminal</h1>
    <span class="user-info" id="user-display"></span>
  </header>
  <div id="messages">
    <div class="message system">Connected. Type / to see available commands.</div>
  </div>
  <div id="input-area">
    <div class="command-help" id="command-help"></div>
    <div id="autocomplete"></div>
    <input type="text" id="command-input" placeholder="Type a message, or / for commands" autocomplete="off">
    <button id="send-btn" onclick="executeCurrentCommand()">Send</button>
  </div>
</div>

<!-- Modal Overlay -->
<div id="modal-overlay">
  <div class="modal-box" id="modal-content"></div>
</div>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let token = null;
let user = null;
let socket = null;
let commands = [];
let currentCommand = null;
let currentOptions = {};
let currentOptionIndex = -1; // which option we're filling
let acItems = [];
let acSelected = -1;
let interactionCounter = 0;
let pendingInteractionId = null;

const $ = (sel) => document.querySelector(sel);
const $messages = $('#messages');
const $input = $('#command-input');
const $ac = $('#autocomplete');
const $help = $('#command-help');

// â”€â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const params = new URLSearchParams(window.location.search);
  const urlToken = params.get('token');

  if (urlToken) {
    // Fresh OAuth redirect â€” save token
    localStorage.setItem('gs_token', urlToken);
    window.history.replaceState({}, '', '/');
    token = urlToken;
  } else {
    // Try saved token
    token = localStorage.getItem('gs_token');
    if (!token) return;
  }

  try {
    const res = await fetch('/api/auth/me', {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    if (!res.ok) {
      // Token expired or invalid
      localStorage.removeItem('gs_token');
      token = null;
      return;
    }

    const me = await res.json();

    if (me.needsSetup) {
      $('#login-screen').style.display = 'none';
      $('#setup-screen').style.display = 'flex';
      $('#setup-name').focus();
      return;
    }

    user = me;
    enterApp();
  } catch (err) {
    console.error('Auth failed:', err);
    localStorage.removeItem('gs_token');
    token = null;
  }
}

async function submitName() {
  const name = $('#setup-name').value.trim();
  if (name.length < 2) {
    $('#setup-error').textContent = 'Name must be at least 2 characters';
    $('#setup-error').style.display = 'block';
    return;
  }

  try {
    const res = await fetch('/api/auth/set-name', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({ displayName: name }),
    });
    const data = await res.json();

    if (!res.ok) {
      $('#setup-error').textContent = data.error || 'Something went wrong';
      $('#setup-error').style.display = 'block';
      return;
    }

    // Refresh user info and enter app
    const meRes = await fetch('/api/auth/me', {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    user = await meRes.json();
    $('#setup-screen').style.display = 'none';
    enterApp();
  } catch (err) {
    $('#setup-error').textContent = 'Failed to set name';
    $('#setup-error').style.display = 'block';
  }
}

function enterApp() {
  $('#login-screen').style.display = 'none';
  $('#setup-screen').style.display = 'none';
  $('#app').classList.add('active');
  $('#user-display').textContent = `Logged in as ${user.displayName || user.username}`;
  loadCommands();
  connectSocket();
  $input.focus();
}

$('#setup-name')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') submitName(); });

checkAuth();

// â”€â”€â”€ Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCommands() {
  const res = await fetch('/api/commands');
  commands = await res.json();
  addMessage('system', `${commands.length} commands loaded: ${commands.map(c => '/' + c.name).join(', ')}`);
}

// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectSocket() {
  socket = io();
  socket.on('connect', () => {
    socket.emit('auth', { token });
  });
  socket.on('authOk', (u) => {
    user = u;
    $('#user-display').textContent = `Logged in as ${u.displayName || u.username}`;
    console.log('Socket authenticated:', u);
  });
  socket.on('authError', (err) => {
    addMessage('error', 'Socket auth failed: ' + err.error);
  });
  socket.on('reply', (data) => renderReply(data));
  socket.on('editReply', (data) => renderReply(data, true));
  socket.on('deferReply', (data) => {
    addMessage('system loading', 'Thinking...', data.interactionId);
  });
  socket.on('deleteReply', (data) => {
    const el = document.querySelector(`[data-interaction="${data.interactionId}"]`);
    if (el) el.remove();
  });
  socket.on('followUp', (data) => renderReply(data));
  socket.on('showModal', (data) => showModal(data));
  socket.on('error', (data) => {
    addMessage('error', data.error);
  });

  // â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  socket.on('chatHistory', (messages) => {
    for (const msg of messages) {
      addChatMessage(msg);
    }
  });
  socket.on('newMessage', (msg) => {
    addChatMessage(msg);
  });
}

// â”€â”€â”€ Message Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addMessage(type, content, interactionId) {
  const div = document.createElement('div');
  div.className = `message ${type}`;
  if (interactionId) div.setAttribute('data-interaction', interactionId);
  div.textContent = renderDiscordMarkdown(content);
  $messages.appendChild(div);
  $messages.scrollTop = $messages.scrollHeight;
  return div;
}

function addChatMessage(msg) {
  const div = document.createElement('div');
  div.className = 'message chat';
  const time = new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const isMe = user && msg.userId === user.id;
  div.innerHTML = `<span class="chat-time">${time}</span> <span class="chat-name${isMe ? ' chat-me' : ''}">${escapeHtml(msg.displayName)}</span> <span class="chat-text">${escapeHtml(msg.content)}</span>`;
  $messages.appendChild(div);
  $messages.scrollTop = $messages.scrollHeight;
  return div;
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str || '';
  return d.innerHTML;
}

function renderDiscordMarkdown(text) {
  if (!text) return '';
  // Strip Discord-specific markdown
  return text
    .replace(/<@!?\d+>/g, '@user')    // user mentions
    .replace(/<@&\d+>/g, '@role')      // role mentions
    .replace(/<t:\d+:?[a-zA-Z]?>/g, new Date().toLocaleString()) // timestamps
    .replace(/`([^`]+)`/g, '$1');      // inline code â†’ just text (it's already monospace)
}

function renderEmoji(text) {
  const emojiMap = {
    ':busts_in_silhouette:': 'ğŸ‘¥', ':bust_in_silhouette:': 'ğŸ‘¤',
    ':crossed_swords:': 'âš”ï¸', ':arrow_double_up:': 'â«', ':arrow_up:': 'â¬†ï¸',
    ':white_check_mark:': 'âœ…', ':x:': 'âŒ', ':bank:': 'ğŸ¦',
    ':mag:': 'ğŸ”', ':money_bag:': 'ğŸ’°', ':moneybag:': 'ğŸ’°',
    ':dragon:': 'ğŸ‰', ':question:': 'â“',
  };
  let result = text || '';
  for (const [code, emoji] of Object.entries(emojiMap)) {
    result = result.replaceAll(code, emoji);
  }
  return result;
}

function renderReply(data, isEdit = false) {
  // Find existing message if editing
  let container;
  if (isEdit && data.interactionId) {
    container = document.querySelector(`[data-interaction="${data.interactionId}"]`);
    if (container) container.innerHTML = '';
  }
  if (!container) {
    container = document.createElement('div');
    container.className = 'message';
    if (data.interactionId) container.setAttribute('data-interaction', data.interactionId);
    $messages.appendChild(container);
  }
  container.className = 'message'; // reset classes

  // Text content
  if (data.content) {
    const textDiv = document.createElement('div');
    textDiv.className = 'text-reply';
    textDiv.textContent = renderEmoji(renderDiscordMarkdown(data.content));
    container.appendChild(textDiv);
  }

  // Embeds
  if (data.embeds) {
    for (const embed of data.embeds) {
      container.appendChild(renderEmbed(embed));
    }
  }

  // Components (buttons, selects)
  if (data.components) {
    for (const row of data.components) {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'components';
      const components = Array.isArray(row) ? row : (row.components || [row]);
      for (const comp of components) {
        if (comp.type === 'button') {
          rowDiv.appendChild(renderButton(comp, data.interactionId));
        } else if (comp.type === 'select') {
          rowDiv.appendChild(renderSelectMenu(comp, data.interactionId));
        }
      }
      container.appendChild(rowDiv);
    }
  }

  $messages.scrollTop = $messages.scrollHeight;
}

function renderEmbed(embed) {
  const div = document.createElement('div');
  div.className = `embed color-${embed.color || 'Green'}`;

  if (embed.title) {
    const title = document.createElement('div');
    title.className = 'embed-title';
    title.textContent = renderEmoji(embed.title);
    div.appendChild(title);
  }

  if (embed.description) {
    const desc = document.createElement('div');
    desc.className = 'embed-description';
    desc.textContent = renderEmoji(renderDiscordMarkdown(embed.description));
    div.appendChild(desc);
  }

  if (embed.fields && embed.fields.length > 0) {
    const fieldsDiv = document.createElement('div');
    fieldsDiv.className = 'embed-fields';
    for (const field of embed.fields) {
      const fieldDiv = document.createElement('div');
      fieldDiv.className = `embed-field ${field.inline === false ? 'full-width' : ''}`;
      const name = document.createElement('div');
      name.className = 'embed-field-name';
      name.textContent = renderEmoji(field.name);
      const value = document.createElement('div');
      value.className = 'embed-field-value';
      value.textContent = renderEmoji(renderDiscordMarkdown(field.value));
      fieldDiv.appendChild(name);
      fieldDiv.appendChild(value);
      fieldsDiv.appendChild(fieldDiv);
    }
    div.appendChild(fieldsDiv);
  }

  return div;
}

function renderButton(btn, parentInteractionId) {
  const button = document.createElement('button');
  button.className = `comp-button style-${btn.style || 'Primary'}`;
  button.textContent = btn.label;
  button.onclick = () => {
    socket.emit('componentInteraction', {
      interactionId: `int_${++interactionCounter}`,
      parentInteractionId,
      customId: btn.customId,
    });
  };
  return button;
}

function renderSelectMenu(menu, parentInteractionId) {
  const select = document.createElement('select');
  select.className = 'comp-select';

  const placeholder = document.createElement('option');
  placeholder.textContent = menu.placeholder || 'Select...';
  placeholder.disabled = true;
  placeholder.selected = true;
  select.appendChild(placeholder);

  for (const opt of menu.options) {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.label;
    select.appendChild(option);
  }

  select.onchange = () => {
    socket.emit('componentInteraction', {
      interactionId: `int_${++interactionCounter}`,
      parentInteractionId,
      customId: menu.customId,
      values: [select.value],
    });
  };
  return select;
}

// â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showModal(data) {
  const overlay = $('#modal-overlay');
  const content = $('#modal-content');
  content.innerHTML = '';

  const title = document.createElement('h3');
  title.textContent = data.title;
  content.appendChild(title);

  const fields = {};
  for (const field of (data.fields || [])) {
    const label = document.createElement('label');
    label.textContent = field.label;
    content.appendChild(label);

    if (field.style === 'paragraph') {
      const textarea = document.createElement('textarea');
      textarea.placeholder = field.placeholder || '';
      textarea.id = `modal-field-${field.customId}`;
      fields[field.customId] = textarea;
      content.appendChild(textarea);
    } else {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = field.placeholder || '';
      input.id = `modal-field-${field.customId}`;
      fields[field.customId] = input;
      content.appendChild(input);
    }
  }

  const actions = document.createElement('div');
  actions.className = 'modal-actions';

  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'comp-button style-Danger';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.onclick = () => { overlay.classList.remove('active'); };

  const submitBtn = document.createElement('button');
  submitBtn.className = 'comp-button style-Success';
  submitBtn.textContent = 'Submit';
  submitBtn.onclick = () => {
    const fieldValues = {};
    for (const [id, el] of Object.entries(fields)) {
      fieldValues[id] = el.value;
    }
    socket.emit('submitModal', {
      interactionId: `int_${++interactionCounter}`,
      modalId: data.customId,
      fields: fieldValues,
    });
    overlay.classList.remove('active');
  };

  actions.appendChild(cancelBtn);
  actions.appendChild(submitBtn);
  content.appendChild(actions);
  overlay.classList.add('active');

  // Focus first field
  const firstField = content.querySelector('textarea, input[type="text"]');
  if (firstField) setTimeout(() => firstField.focus(), 100);
}

// â”€â”€â”€ Command Input / Autocomplete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$input.addEventListener('input', () => {
  const val = $input.value;

  if (val.startsWith('/')) {
    const parts = val.slice(1).split(/\s+/);
    const cmdName = parts[0].toLowerCase();

    if (parts.length === 1 && !val.includes(' ')) {
      // Show command autocomplete
      showCommandAutocomplete(cmdName);
      return;
    }

    // We have a command selected, show option help
    const cmd = commands.find(c => c.name === cmdName);
    if (cmd) {
      currentCommand = cmd;
      parseOptionsFromInput(parts.slice(1), cmd);
      // Check if current option has autocomplete
      const currentOpt = cmd.options[currentOptionIndex];
      if (currentOpt?.autocomplete) {
        const currentValue = parts[parts.length - 1] || '';
        fetchAutocomplete(cmdName, currentOpt.name, currentValue);
      } else {
        hideAutocomplete();
      }
      showCommandHelp(cmd);
    }
  } else {
    hideAutocomplete();
    hideCommandHelp();
  }
});

$input.addEventListener('keydown', (e) => {
  if (e.key === 'Tab' && $ac.classList.contains('active')) {
    e.preventDefault();
    if (acSelected >= 0 && acSelected < acItems.length) {
      selectAutocompleteItem(acItems[acSelected]);
    }
    return;
  }
  if (e.key === 'ArrowDown' && $ac.classList.contains('active')) {
    e.preventDefault();
    acSelected = Math.min(acSelected + 1, acItems.length - 1);
    updateAcSelection();
    return;
  }
  if (e.key === 'ArrowUp' && $ac.classList.contains('active')) {
    e.preventDefault();
    acSelected = Math.max(acSelected - 1, 0);
    updateAcSelection();
    return;
  }
  if (e.key === 'Enter') {
    if ($ac.classList.contains('active') && acSelected >= 0) {
      e.preventDefault();
      selectAutocompleteItem(acItems[acSelected]);
    } else {
      e.preventDefault();
      executeCurrentCommand();
    }
  }
  if (e.key === 'Escape') {
    hideAutocomplete();
    hideCommandHelp();
  }
});

function showCommandAutocomplete(partial) {
  const matches = commands.filter(c => c.name.startsWith(partial));
  if (matches.length === 0) { hideAutocomplete(); return; }

  acItems = matches.map(c => ({ name: `/${c.name}`, value: c.name, desc: c.description }));
  acSelected = 0;
  renderAutocomplete();
}

function renderAutocomplete() {
  $ac.innerHTML = '';
  for (let i = 0; i < acItems.length; i++) {
    const div = document.createElement('div');
    div.className = `ac-item ${i === acSelected ? 'selected' : ''}`;
    div.innerHTML = `<span class="ac-name">${acItems[i].name}</span><span class="ac-desc">${acItems[i].desc || ''}</span>`;
    div.onclick = () => selectAutocompleteItem(acItems[i]);
    $ac.appendChild(div);
  }
  $ac.classList.add('active');
}

function updateAcSelection() {
  const items = $ac.querySelectorAll('.ac-item');
  items.forEach((el, i) => el.classList.toggle('selected', i === acSelected));
}

function selectAutocompleteItem(item) {
  const val = $input.value;
  const parts = val.slice(1).split(/\s+/);

  if (parts.length <= 1) {
    // Selecting a command
    $input.value = `/${item.value} `;
    hideAutocomplete();
    $input.dispatchEvent(new Event('input'));
  } else {
    // Selecting an option value
    parts[parts.length - 1] = item.value;
    $input.value = '/' + parts.join(' ') + ' ';
    hideAutocomplete();
    $input.dispatchEvent(new Event('input'));
  }
  $input.focus();
}

function hideAutocomplete() {
  $ac.classList.remove('active');
  acItems = [];
  acSelected = -1;
}

async function fetchAutocomplete(cmdName, optionName, value) {
  try {
    const res = await fetch(`/api/commands/${cmdName}/autocomplete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({
        options: { [optionName]: value },
        focused: { name: optionName, value },
      }),
    });
    const choices = await res.json();
    if (choices.length > 0) {
      acItems = choices.map(c => ({ name: c.name, value: c.value, desc: '' }));
      acSelected = 0;
      renderAutocomplete();
    } else {
      hideAutocomplete();
    }
  } catch (err) {
    console.error('Autocomplete error:', err);
  }
}

function showCommandHelp(cmd) {
  if (!cmd.options || cmd.options.length === 0) { hideCommandHelp(); return; }

  const parts = cmd.options.map((opt, i) => {
    const cls = opt.required ? 'opt required' : 'opt';
    const marker = i === currentOptionIndex ? 'â–¶ ' : '';
    return `${marker}<span class="${cls}">${opt.name}</span>: ${opt.description}`;
  }).join(' | ');

  $help.innerHTML = `/${cmd.name} â€” ${parts}`;
  $help.classList.add('active');
}

function hideCommandHelp() {
  $help.classList.remove('active');
}

function parseOptionsFromInput(argParts, cmd) {
  currentOptions = {};
  currentOptionIndex = -1;

  for (let i = 0; i < cmd.options.length && i < argParts.length; i++) {
    const opt = cmd.options[i];
    const val = argParts[i];
    if (val !== undefined && val !== '') {
      if (opt.type === 'integer' || opt.type === 'number') {
        currentOptions[opt.name] = Number(val);
      } else if (opt.type === 'boolean') {
        currentOptions[opt.name] = val === 'true';
      } else {
        currentOptions[opt.name] = val;
      }
    }
  }

  // Current option is the one being typed (last arg)
  const typingIndex = argParts.length - 1;
  if (typingIndex >= 0 && typingIndex < cmd.options.length) {
    currentOptionIndex = typingIndex;
  }
}

// â”€â”€â”€ Execute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function executeCurrentCommand() {
  const val = $input.value.trim();
  if (!val) return;

  // Regular chat message
  if (!val.startsWith('/')) {
    socket.emit('chatMessage', { content: val });
    $input.value = '';
    return;
  }

  hideAutocomplete();
  hideCommandHelp();

  const parts = val.slice(1).split(/\s+/);
  const cmdName = parts[0].toLowerCase();
  const cmd = commands.find(c => c.name === cmdName);

  if (!cmd) {
    addMessage('error', `Unknown command: /${cmdName}`);
    $input.value = '';
    return;
  }

  // Build options from positional args
  const options = {};
  for (let i = 0; i < cmd.options.length && i + 1 < parts.length; i++) {
    const opt = cmd.options[i];
    const val = parts[i + 1];
    if (opt.type === 'integer' || opt.type === 'number') {
      options[opt.name] = Number(val);
    } else if (opt.type === 'boolean') {
      options[opt.name] = val === 'true';
    } else {
      options[opt.name] = val;
    }
  }

  addMessage('command', val);

  const interactionId = `int_${++interactionCounter}`;
  pendingInteractionId = interactionId;

  socket.emit('executeCommand', {
    interactionId,
    command: cmdName,
    options,
  });

  $input.value = '';
}
</script>
</body>
</html>
